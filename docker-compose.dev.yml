version: '3.8'

# Local Development Docker Compose

services:
  # Terminal container
  terminal:
    build:
      context: ./apps/api
      dockerfile: terminal.Dockerfile
    container_name: terminal-shared
    hostname: mikeos
    read_only: true
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    network_mode: none
    user: '1000:1000'
    mem_limit: ${CONTAINER_MEMORY:-1g}
    cpus: ${CONTAINER_CPUS:-1.0}
    tmpfs:
      - /tmp:size=256m
      - /var/tmp:size=256m
    volumes:
      - terminal-workspace:/workspace:rw
    restart: unless-stopped
    command: tail -f /dev/null

  # Redis
  redis:
    image: redis:8-alpine
    ports:
      - '6379:6379'
    volumes:
      - redis-data:/data

  # Jekyll Blog (for local testing)
  # Uses cached image - no pulling needed after first run
  blog:
    image: jekyll/jekyll:latest
    ports:
      - '4000:4000'
      - '35729:35729'
    volumes:
      - ./blog:/srv/jekyll
      - jekyll-bundle-cache:/usr/local/bundle
    working_dir: /srv/jekyll
    command: sh -c "bundle install --quiet && bundle exec jekyll serve --host 0.0.0.0 --port 4000 --baseurl '' --force_polling --livereload"

volumes:
  redis-data:
  terminal-workspace:
  jekyll-bundle-cache:
