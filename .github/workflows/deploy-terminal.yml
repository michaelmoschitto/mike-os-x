name: Deploy Terminal Container

on:
  push:
    branches: [main]
    paths:
      - 'apps/api/terminal.Dockerfile'
      - 'apps/api/docker-compose.terminal.yml'
  release:
    types: [published]
  workflow_dispatch:

jobs:
  deploy-terminal:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Pulumi
        uses: pulumi/actions@v5

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        working-directory: iac
        run: bun install

      - name: Validate required secrets
        run: |
          MISSING_SECRETS=()

          if [ -z "${{ secrets.PULUMI_PASSPHRASE }}" ]; then
            MISSING_SECRETS+=("PULUMI_PASSPHRASE")
          fi

          if [ -z "${{ secrets.EC2_SSH_KEY }}" ]; then
            MISSING_SECRETS+=("EC2_SSH_KEY")
          fi

          if [ ${#MISSING_SECRETS[@]} -gt 0 ]; then
            echo "::error::Missing required GitHub secrets: ${MISSING_SECRETS[*]}"
            echo "Please configure these secrets in your repository settings:"
            for secret in "${MISSING_SECRETS[@]}"; do
              echo "  - $secret"
            done
            exit 1
          fi

          echo "✅ All required secrets are configured"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-west-2

      - name: Set Pulumi passphrase
        run: |
          echo "PULUMI_CONFIG_PASSPHRASE=${{ secrets.PULUMI_PASSPHRASE }}" >> $GITHUB_ENV
          echo "AWS_REGION=us-west-2" >> $GITHUB_ENV

      - name: Login to Pulumi (S3 backend)
        run: pulumi login s3://mike-os-x-pulumi-state

      - name: Get EC2 IP from Pulumi
        id: get_ip
        working-directory: iac
        run: |
          pulumi stack select default
          EC2_IP=$(pulumi stack output publicIp --show-secrets)

          if [ -z "$EC2_IP" ]; then
            echo "::error::Could not get EC2 IP from Pulumi stack '$STACK'."
            echo "Please ensure:"
            echo "  1. Infrastructure has been deployed (run 'Deploy Infrastructure' workflow first)"
            echo "  2. PULUMI_STACK secret matches the stack name used during infrastructure deployment"
            exit 1
          fi

          echo "EC2_IP=$EC2_IP" >> $GITHUB_OUTPUT
          echo "EC2 IP: $EC2_IP"

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ steps.get_ip.outputs.EC2_IP }} >> ~/.ssh/known_hosts

      - name: Clone or update repository on EC2
        run: |
          ssh ubuntu@${{ steps.get_ip.outputs.EC2_IP }} << 'EOF'
            set -e
            if [ ! -d ~/mike-os-x/.git ]; then
              git clone https://github.com/${{ github.repository }}.git ~/mike-os-x
            fi
          EOF

      - name: Deploy terminal container
        run: |
          ssh ubuntu@${{ steps.get_ip.outputs.EC2_IP }} << 'EOF'
            set -e
            cd ~/mike-os-x
            
            if [ "${{ github.event_name }}" = "release" ]; then
              git fetch --tags
              git checkout ${{ github.event.release.tag_name }}
            else
              git fetch origin main
              git checkout main
            fi
            
            cd apps/api
            docker-compose -f docker-compose.terminal.yml build terminal
            docker-compose -f docker-compose.terminal.yml up -d terminal
            
            sleep 2
            docker ps | grep terminal-shared || exit 1
            echo "✅ Terminal container deployed successfully"
          EOF

      - name: Verify Terminal Health
        run: |
          ssh ubuntu@${{ steps.get_ip.outputs.EC2_IP }} << 'EOF'
            docker exec terminal-shared echo "Terminal healthy" || exit 1
          EOF

      - name: Summary
        run: |
          echo "## Terminal Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**EC2 IP:** \`${{ steps.get_ip.outputs.EC2_IP }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event_name }}" = "release" ]; then
            echo "**Deployed from release:** \`${{ github.event.release.tag_name }}\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Deployed from branch:** \`main\`" >> $GITHUB_STEP_SUMMARY
          fi
